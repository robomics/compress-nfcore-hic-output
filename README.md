<!--
Copyright (C) 2023 Roberto Rossini <roberros@uio.no>

SPDX-License-Identifier: MIT
-->

# Nextflow workflow to compress nf-core/hic output

This repository hosts a Nextflow workflow to compress the output produced by [nf-core/hic](https://nf-co.re/hic) v2+.

## Requirements

### Software requirements

- Nextflow (at least version: v20.07.1. Pipeline was developed using v22.10.6)
- Docker or Singularity/Apptainer

### Required input files

The workflow requires two inputs:
1. The output folder produced by [nf-core/hic](https://nf-co.re/hic)
2. The reference genome used for mapping by [nf-core/hic](https://nf-co.re/hic)

### Running the workflow

The workflow can be run as follows:

```bash
nextflow run --nfcore_hic_outdir='nfcore_hic_results/' \
             --fasta='hg38.fa' \
             --outdir='results/' \
             https://github.com/robomics/compress-nfcore-hic-output \
             -r v0.0.1 \
             -with-singularity  # Replace this with -with-docker to use Docker instead
```

This will produce the following outputs:
1. `results/alignment`: Folder containing the `bwt2pairs` files in CRAM format (one per sample). With default settings, the refernce genome is embedded in the `.cram``files.
2. `results/stats`: Folder containing one `.tar.xz` file for each `stats` folder produced by [nf-core/hic](https://nf-co.re/hic).
3. `results/validpairs`: Folder containing the `.allValidPairs` files compressed using `xz`.
4. `results/multiqc.tar.xz`: TAR archive containing the report generated by [MultiQC](https://multiqc.info/).

<details>
<summary>Troubleshooting</summary>

__Permission errors when running pipeline with `-with-docker`__:

Try to pass option `-process.containerOptions="--user root"` to `nextflow run`

__Cannot find revision `vx.x.x`__:

Try to remove folder `~/.nextflow/assets/robomics/compress-nfcore-hic-output` before running the workflow

__Error 403 when pulling containers from ghcr.io__:

In order to pull docker images from `ghcr.io`, you first need to log in to `ghcr.io/robomics`.

1. Follow GitHub instructions to generate a personal access token (PAT): [docs](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token#creating-a-personal-access-token-classic)
2. Run `docker login` or `singularity remote` to login into the remote.

Example:

```bash
# Using Docker
docker login -u your-github-username ghcr.io/robomics

# Using singularity
singularity remote login -u your-github-username docker://ghcr.io/robomics

# You will now be prompted to enter your PAT
```

</details>

## Getting help

If you are having trouble running the workflow feel free to reach out by starting a new discussion [here](https://github.com/robomics/compress-nfcore-hic-output/discussions).

Bug reports and feature requests can be submitted by opening an [issue](https://github.com/robomics/compress-nfcore-hic-output/issues).
